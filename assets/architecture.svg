<svg xmlns="http://www.w3.org/2000/svg" width="980" height="620" viewBox="0 0 980 620">
  <defs>
    <style>
      .box { fill: #ffffff; stroke: #2b6cb0; stroke-width: 2; rx: 8; ry: 8; }
      .header { fill: #2b6cb0; font: bold 14px sans-serif; letter-spacing: 0.3px; }
      .label { fill: #1a202c; font: 12px sans-serif; }
      .small { fill: #4a5568; font: 11px sans-serif; }
      .arrow { stroke: #4a5568; stroke-width: 2; marker-end: url(#arrowhead); fill: none; }
      .group { fill: #f7fafc; stroke: #cbd5e0; stroke-width: 1; rx: 10; ry: 10; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#4a5568" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="20" y="30" class="header">System Architecture & Data Flow</text>
  <text x="20" y="50" class="small">High-level flow of data and control through the risk manager</text>

  <!-- CLI & Orchestration -->
  <rect x="40" y="80" width="260" height="80" class="box" />
  <text x="60" y="105" class="label">CLI Entrypoint</text>
  <text x="60" y="125" class="small">risk-manager (market_analysis/__main__.py)</text>
  <text x="60" y="145" class="small">Args: --monitor, --interval, --iterations, --print-report</text>

  <!-- Position Risk Manager -->
  <rect x="340" y="80" width="300" height="80" class="box" />
  <text x="360" y="105" class="label">PositionRiskManager</text>
  <text x="360" y="125" class="small">Fetch positions, drive per-position analysis</text>
  <text x="360" y="145" class="small">Aggregates portfolio metrics & reporting</text>

  <!-- CCXT / Bybit -->
  <rect x="700" y="70" width="240" height="100" class="box" />
  <text x="720" y="95" class="label">Exchange (ccxt.bybit)</text>
  <text x="720" y="115" class="small">‚Ä¢ fetch_positions, fetch_ticker</text>
  <text x="720" y="135" class="small">‚Ä¢ fetch_ohlcv (multi timeframes)</text>

  <!-- Config & Secrets -->
  <rect x="40" y="200" width="260" height="110" class="box" />
  <text x="60" y="225" class="label">Configuration & Secrets</text>
  <text x="60" y="245" class="small">settings.toml ‚Üí market_analysis/config.py</text>
  <text x="60" y="265" class="small">.env ‚Üí BYBIT_API_KEY/SECRET</text>

  <!-- Volatility & Risk Engine Group -->
  <rect x="340" y="200" width="600" height="240" class="group" />
  <text x="355" y="220" class="small">Volatility & Risk Engine</text>

  <rect x="360" y="240" width="260" height="80" class="box" />
  <text x="380" y="265" class="label">Volatility Models</text>
  <text x="380" y="285" class="small">HAR-RV, GARCH(1,1), ATR</text>
  <text x="380" y="305" class="small">Blend, outlier checks, œÉ_H horizon</text>

  <rect x="640" y="240" width="280" height="80" class="box" />
  <text x="660" y="265" class="label">Stops / Targets</text>
  <text x="660" y="285" class="small">k√óATR SL, m√óATR TP, leverage bands</text>
  <text x="660" y="305" class="small">Size vs risk_target_pct</text>

  <rect x="360" y="340" width="260" height="80" class="box" />
  <text x="380" y="365" class="label">Dynamic State-Anchored</text>
  <text x="380" y="385" class="small">Breakeven, ATR trailing, m_eff by P(TP)</text>

  <rect x="640" y="340" width="280" height="80" class="box" />
  <text x="660" y="365" class="label">Portfolio Correlation</text>
  <text x="660" y="385" class="small">Clustering & cluster risk caps</text>

  <!-- Reporting -->
  <rect x="40" y="350" width="260" height="90" class="box" />
  <text x="60" y="375" class="label">Reporting</text>
  <text x="60" y="395" class="small">Console Table + risk_analysis.json</text>

  <!-- Outputs -->
  <rect x="40" y="470" width="420" height="100" class="group" />
  <text x="55" y="490" class="small">Outputs</text>
  <rect x="60" y="505" width="190" height="50" class="box" />
  <text x="75" y="535" class="small">üìÑ risk_analysis.json</text>
  <rect x="270" y="505" width="170" height="50" class="box" />
  <text x="285" y="535" class="small">üñ•Ô∏è Summary Table</text>

  <!-- Arrows -->
  <path d="M300 120 L340 120" class="arrow" />
  <path d="M640 120 L700 120" class="arrow" />
  <path d="M170 160 L170 200" class="arrow" />
  <path d="M300 255 L340 255" class="arrow" />
  <path d="M470 160 L470 200" class="arrow" />
  <path d="M840 170 L840 240" class="arrow" />
  <path d="M490 320 L490 340" class="arrow" />
  <path d="M640 280 L620 280" class="arrow" />
  <path d="M640 380 L620 380" class="arrow" />
  <path d="M340 380 L300 380" class="arrow" />
  <path d="M170 440 L170 470" class="arrow" />

  <!-- Legend -->
  <rect x="500" y="470" width="440" height="100" class="group" />
  <text x="515" y="490" class="small">Legend</text>
  <text x="515" y="510" class="small">‚Ä¢ Dark blue boxes: primary modules</text>
  <text x="515" y="528" class="small">‚Ä¢ Light group boxes: logical subsystems</text>
  <text x="515" y="546" class="small">‚Ä¢ Arrows: data/control flow</text>
</svg>