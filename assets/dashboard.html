<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Risk Manager Control Deck</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #03040d;
      --bg-alt: rgba(8, 14, 32, 0.85);
      --bg-panel: rgba(12, 20, 45, 0.85);
      --bg-panel-alt: rgba(17, 29, 65, 0.6);
      --border: rgba(103, 200, 255, 0.14);
      --text: #eaf4ff;
      --muted: #7da0c8;
      --accent: #4ef7ff;
      --accent-strong: #ff57f6;
      --accent-soft: rgba(78, 247, 255, 0.1);
      --danger: #ff5370;
      --warn: #ffb95a;
      --success: #3ddc91;
      --shadow: 0 40px 80px rgba(8, 12, 30, 0.55);
      --glow-accent: 0 0 22px rgba(78, 247, 255, 0.35);
      --glow-magenta: 0 0 16px rgba(255, 87, 246, 0.35);
      --transition: 220ms ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Space Grotesk', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top left, rgba(108, 53, 255, 0.28), transparent 45%),
                  radial-gradient(circle at 30% 70%, rgba(59, 236, 255, 0.22), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(255, 70, 189, 0.18), transparent 45%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image: linear-gradient(rgba(255, 255, 255, 0.06) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
      background-size: 120px 120px;
      opacity: 0.35;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .app {
      display: grid;
      grid-template-columns: 250px 1fr;
      min-height: 100vh;
      backdrop-filter: blur(16px);
    }

    aside.sidebar {
      position: sticky;
      top: 0;
      align-self: start;
      min-height: 100vh;
      padding: 2.4rem 2rem;
      background: linear-gradient(180deg, rgba(7, 12, 28, 0.85) 0%, rgba(7, 12, 28, 0.4) 70%, rgba(7, 12, 28, 0.2) 100%);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 2.6rem;
    }

    .logo {
      font-family: 'Rajdhani', sans-serif;
      font-size: 1.6rem;
      letter-spacing: 0.15rem;
      text-transform: uppercase;
      display: flex;
      align-items: baseline;
      gap: 0.35rem;
    }

    .logo span {
      color: var(--accent);
      text-shadow: var(--glow-accent);
    }

    .tagline {
      font-size: 0.85rem;
      color: var(--muted);
      max-width: 14ch;
      line-height: 1.5;
    }

    nav {
      display: flex;
      flex-direction: column;
      gap: 1.75rem;
    }

    .nav-section {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .section-label {
      font-size: 0.75rem;
      letter-spacing: 0.28rem;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.42);
    }

    .nav-link {
      position: relative;
      padding: 0.65rem 1rem;
      border-radius: 10px;
      color: var(--text);
      text-decoration: none;
      font-size: 0.92rem;
      background: linear-gradient(90deg, rgba(78, 247, 255, 0.15), rgba(78, 247, 255, 0.02));
      border: 1px solid rgba(78, 247, 255, 0.15);
      transition: transform var(--transition), box-shadow var(--transition), border-color var(--transition);
    }

    .nav-link::after {
      content: "";
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
      opacity: 0;
      transition: opacity var(--transition);
      box-shadow: var(--glow-accent);
    }

    .nav-link:hover,
    .nav-link:focus-visible {
      transform: translateX(6px);
      border-color: rgba(78, 247, 255, 0.35);
      box-shadow: var(--glow-accent);
    }

    .nav-link:hover::after,
    .nav-link:focus-visible::after {
      opacity: 1;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.4);
      line-height: 1.6;
    }

    .main {
      display: flex;
      flex-direction: column;
      padding: 2rem 2.5rem 2.5rem;
      gap: 2rem;
    }

    header.topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
    }

    .brand-title {
      font-family: 'Rajdhani', sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.4rem;
      font-size: 1.25rem;
    }

    .conn-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.45rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(78, 247, 255, 0.22);
      background: rgba(6, 20, 35, 0.55);
      box-shadow: inset 0 0 12px rgba(78, 247, 255, 0.08);
      font-size: 0.85rem;
      color: var(--muted);
    }

    .conn-pulse {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      position: relative;
      box-shadow: 0 0 0 0 rgba(78, 247, 255, 0.45);
      transition: background var(--transition), box-shadow var(--transition);
    }

    .conn-pulse::after {
      content: "";
      position: absolute;
      inset: -4px;
      border-radius: inherit;
      border: 1px solid rgba(78, 247, 255, 0.4);
      opacity: 0;
      transition: opacity var(--transition);
    }

    .conn-live {
      background: var(--success);
      box-shadow: 0 0 0 3px rgba(61, 220, 145, 0.35);
    }

    .conn-live::after {
      opacity: 1;
      animation: pulse 1.6s ease-out infinite;
    }

    .conn-offline {
      background: var(--danger);
      box-shadow: 0 0 0 3px rgba(255, 83, 112, 0.3);
    }

    @keyframes pulse {
      0% { transform: scale(0.95); opacity: 1; }
      100% { transform: scale(1.8); opacity: 0; }
    }

    .summary-strip {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1.2rem;
    }

    .summary-card {
      position: relative;
      padding: 1rem 1.1rem;
      background: linear-gradient(135deg, rgba(78, 247, 255, 0.2), rgba(78, 247, 255, 0.05));
      border-radius: 14px;
      border: 1px solid rgba(78, 247, 255, 0.18);
      overflow: hidden;
      box-shadow: var(--glow-accent);
    }

    .summary-card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(140deg, transparent 25%, rgba(255, 87, 246, 0.25), transparent 75%);
      mix-blend-mode: screen;
      opacity: 0.4;
      pointer-events: none;
    }

    .summary-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.18rem;
      color: rgba(255, 255, 255, 0.55);
    }

    .summary-value {
      margin-top: 0.55rem;
      font-size: 1.45rem;
      font-weight: 600;
    }

    .grid {
      display: grid;
      gap: 1.5rem;
    }

    .grid.two {
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.2fr);
    }

    .grid.three {
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }

    .panel {
      position: relative;
      padding: 1.6rem;
      background: var(--bg-panel);
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, rgba(255, 87, 246, 0.16), rgba(78, 247, 255, 0.08));
      opacity: 0.35;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .panel h2 {
      margin: 0 0 1rem;
      font-family: 'Rajdhani', sans-serif;
      font-size: 1.1rem;
      letter-spacing: 0.12rem;
      text-transform: uppercase;
    }

    .panel p {
      margin: 0;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .metric-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
    }

    .metric {
      padding: 0.9rem;
      border-radius: 12px;
      background: linear-gradient(160deg, rgba(20, 32, 65, 0.85), rgba(20, 32, 65, 0.45));
      border: 1px solid rgba(78, 247, 255, 0.12);
    }

    .metric .k {
      font-size: 0.78rem;
      letter-spacing: 0.08rem;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.55);
    }

    .metric .v {
      margin-top: 0.55rem;
      font-size: 1.1rem;
      font-weight: 500;
    }

    .risk-alerts {
      display: flex;
      flex-wrap: wrap;
      gap: 0.55rem;
      margin-top: 0.85rem;
    }

    .chip {
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      letter-spacing: 0.08rem;
      text-transform: uppercase;
      background: rgba(255, 185, 90, 0.18);
      border: 1px solid rgba(255, 185, 90, 0.5);
      color: #ffd79b;
      box-shadow: 0 0 12px rgba(255, 185, 90, 0.2);
    }

    .chip.danger {
      background: rgba(255, 83, 112, 0.18);
      border-color: rgba(255, 83, 112, 0.5);
      color: #ff9fae;
      box-shadow: 0 0 12px rgba(255, 83, 112, 0.25);
    }

    .panel .subtle {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.55);
    }

    .chart-wrap {
      position: relative;
      height: 240px;
      margin-top: 0.5rem;
    }

    .chart-wrap canvas {
      width: 100%;
      height: 100%;
    }

    .action-feed {
      list-style: none;
      margin: 1.2rem 0 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .action-feed li {
      padding: 0.85rem 1rem;
      background: linear-gradient(120deg, rgba(255, 87, 246, 0.12), rgba(255, 87, 246, 0.02));
      border-radius: 14px;
      border: 1px solid rgba(255, 87, 246, 0.22);
      display: grid;
      gap: 0.3rem;
    }

    .action-feed .symbol {
      font-size: 0.85rem;
      letter-spacing: 0.12rem;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.65);
    }

    .positions-section {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .positions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.4rem;
    }

    .position-card {
      position: relative;
      padding: 1.35rem;
      background: linear-gradient(160deg, rgba(18, 28, 60, 0.92), rgba(18, 28, 60, 0.65));
      border-radius: 18px;
      border: 1px solid rgba(78, 247, 255, 0.16);
      box-shadow: 0 24px 48px rgba(6, 14, 34, 0.55);
      display: flex;
      flex-direction: column;
      gap: 1.05rem;
    }

    .position-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, rgba(78, 247, 255, 0.2), rgba(78, 247, 255, 0.05));
      opacity: 0.25;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .position-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .symbol-block {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .symbol-name {
      font-family: 'Rajdhani', sans-serif;
      letter-spacing: 0.2rem;
      font-size: 1.05rem;
      text-transform: uppercase;
    }

    .side-tag {
      font-size: 0.72rem;
      letter-spacing: 0.24rem;
      text-transform: uppercase;
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
    }

    .side-tag.long {
      color: var(--accent);
      border-color: rgba(78, 247, 255, 0.45);
      box-shadow: 0 0 12px rgba(78, 247, 255, 0.25);
    }

    .side-tag.short {
      color: var(--danger);
      border-color: rgba(255, 83, 112, 0.45);
      box-shadow: 0 0 12px rgba(255, 83, 112, 0.25);
    }

    .health-badge {
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      font-size: 0.72rem;
      letter-spacing: 0.16rem;
      text-transform: uppercase;
      border: 1px solid rgba(255, 255, 255, 0.18);
      color: rgba(255, 255, 255, 0.7);
    }

    .health-badge.warning {
      background: rgba(255, 185, 90, 0.16);
      border-color: rgba(255, 185, 90, 0.45);
      color: #ffd79b;
      box-shadow: 0 0 14px rgba(255, 185, 90, 0.18);
    }

    .health-badge.critical {
      background: rgba(255, 83, 112, 0.16);
      border-color: rgba(255, 83, 112, 0.5);
      color: #ff9fae;
      box-shadow: 0 0 14px rgba(255, 83, 112, 0.22);
    }

    .level-group {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.65rem;
    }

    .level {
      padding: 0.65rem 0.75rem;
      border-radius: 12px;
      background: rgba(12, 24, 54, 0.75);
      border: 1px solid rgba(78, 247, 255, 0.16);
      display: grid;
      gap: 0.35rem;
    }

    .level .label {
      font-size: 0.72rem;
      letter-spacing: 0.2rem;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.55);
    }

    .level .value {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .position-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.7rem;
    }

    .position-metrics .metric {
      background: rgba(20, 32, 68, 0.75);
      border: 1px solid rgba(78, 247, 255, 0.12);
    }

    .confidence {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
    }

    .confidence .factor {
      padding: 0.3rem 0.65rem;
      border-radius: 999px;
      font-size: 0.72rem;
      letter-spacing: 0.08rem;
      background: rgba(78, 247, 255, 0.12);
      border: 1px solid rgba(78, 247, 255, 0.25);
      color: rgba(78, 247, 255, 0.85);
    }

    .action-text {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.72);
      line-height: 1.5;
    }

    .footer {
      margin-top: auto;
      text-align: center;
      font-size: 0.78rem;
      color: rgba(255, 255, 255, 0.4);
      padding: 1rem 0 0;
    }

    @media (max-width: 1080px) {
      .app {
        grid-template-columns: 1fr;
      }

      aside.sidebar {
        position: relative;
        min-height: auto;
        border-right: none;
        border-bottom: 1px solid var(--border);
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        padding: 1.6rem 2rem;
        gap: 1.5rem;
      }

      aside.sidebar nav,
      aside.sidebar .sidebar-footer,
      aside.sidebar .tagline {
        display: none;
      }

      .main {
        padding: 2rem 1.5rem 3rem;
      }
    }

    @media (max-width: 720px) {
      .summary-strip {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }

      .grid.two {
        grid-template-columns: 1fr;
      }

      .positions-grid {
        grid-template-columns: 1fr;
      }

      header.topbar {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="logo">Risk<span>Matrix</span></div>
      <div class="tagline">Autonomous risk intelligence for Bybit derivatives.</div>
      <nav>
        <div class="nav-section">
          <span class="section-label">Monitor</span>
          <a class="nav-link" href="#overview">Portfolio Overview</a>
          <a class="nav-link" href="#positions">Positions</a>
          <a class="nav-link" href="#actions">Actions</a>
        </div>
        <div class="nav-section">
          <span class="section-label">Analytics</span>
          <a class="nav-link" href="#pnl">PnL History</a>
          <a class="nav-link" href="#exposure">Exposure Mix</a>
        </div>
      </nav>
      <div class="sidebar-footer">
        CYBERNETIC RISK CORE v1.4<br />
        Adaptive SL/TP • Volatility-aware sizing
      </div>
    </aside>
    <div class="main">
      <header class="topbar">
        <div class="brand-title">Bybit Risk Command Deck</div>
        <div class="conn-indicator">
          <span id="conn-pulse" class="conn-pulse"></span>
          <span id="conn-text">Connecting…</span>
        </div>
      </header>

      <section class="summary-strip" id="overview">
        <div class="summary-card">
          <div class="summary-label">Open Positions</div>
          <div class="summary-value" id="summary-positions">-</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Total Unrealized PnL</div>
          <div class="summary-value" id="summary-unrealized">-</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Total Risk @ SL</div>
          <div class="summary-value" id="summary-risk">-</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Last Updated</div>
          <div class="summary-value" id="data-timestamp">--:--</div>
        </div>
      </section>

      <section class="grid two">
        <article class="panel" id="pnl">
          <h2>Portfolio PnL Trajectory</h2>
          <p class="subtle">34 hour rolling capture of unrealized and realized PnL.</p>
          <div class="chart-wrap"><canvas id="pnlChart"></canvas></div>
        </article>
        <article class="panel" id="exposure">
          <h2>Risk / Reward Exposure</h2>
          <p class="subtle">Comparative view of current dollar risk vs. reward by symbol.</p>
          <div class="chart-wrap" style="height: 220px;"><canvas id="riskChart"></canvas></div>
        </article>
      </section>

      <section class="grid three" id="overview-panels">
        <article class="panel">
          <h2>Portfolio Snapshot</h2>
          <div class="metric-grid" id="portfolio-grid"></div>
          <div class="risk-alerts" id="risk-alerts"></div>
        </article>
        <article class="panel">
          <h2>Account Metrics</h2>
          <div class="metric-grid" id="account-grid"></div>
          <p class="subtle" id="portfolio-rr">Risk/Reward — : --</p>
        </article>
        <article class="panel" id="actions">
          <h2>Priority Actions</h2>
          <p class="subtle">Auto-ranked tasks from the risk engine for immediate review.</p>
          <ul class="action-feed" id="action-feed"></ul>
        </article>
      </section>

      <section class="positions-section" id="positions">
        <h2 style="font-family: 'Rajdhani', sans-serif; letter-spacing: 0.18rem; text-transform: uppercase; margin: 0;">Live Position Intelligence</h2>
        <div class="positions-grid" id="positions-grid"></div>
      </section>

      <div class="footer">Real-time recalibration of targets, SL/TP automation, and volatility-adjusted sizing.</div>
    </div>
  </div>

  <script>
    const positionsEl = document.getElementById('positions-grid');
    const portfolioEl = document.getElementById('portfolio-grid');
    const accountEl = document.getElementById('account-grid');
    const actionFeedEl = document.getElementById('action-feed');
    const riskAlertsEl = document.getElementById('risk-alerts');
    const connPulse = document.getElementById('conn-pulse');
    const connText = document.getElementById('conn-text');
    const summaryPositions = document.getElementById('summary-positions');
    const summaryUnrealized = document.getElementById('summary-unrealized');
    const summaryRisk = document.getElementById('summary-risk');
    const timestampEl = document.getElementById('data-timestamp');
    const portfolioRrEl = document.getElementById('portfolio-rr');

    const pnlCanvas = document.getElementById('pnlChart');
    const riskCanvas = document.getElementById('riskChart');
    const THIRTY_FOUR_HOURS_MS = 34 * 60 * 60 * 1000;
    const SAMPLE_EVERY_MS = 60 * 1000;
    let lastSampleAt = 0;
    const pnlSeries = [];

    let pnlChart = null;
    let riskChart = null;

    const severityRank = {
      CRITICAL: 0,
      WARNING: 1,
      PROFITABLE: 2,
      NORMAL: 3,
      INFO: 4,
      UNKNOWN: 5,
    };

    function toNumber(val) {
      const n = Number(val);
      return Number.isFinite(n) ? n : 0;
    }

    function fmt(val, digits = 2) {
      if (val === null || val === undefined || Number.isNaN(Number(val))) return '-';
      const num = Number(val);
      if (Math.abs(num) >= 1000) return num.toLocaleString(undefined, { maximumFractionDigits: digits });
      return num.toFixed(digits);
    }

    function formatCurrency(val) {
      if (val === null || val === undefined || Number.isNaN(Number(val))) return '-';
      return `$${Number(val).toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
    }

    function formatPercent(val, digits = 2) {
      if (val === null || val === undefined || Number.isNaN(Number(val))) return '-';
      return `${Number(val).toFixed(digits)}%`;
    }

    (function initCharts() {
      try {
        pnlChart = new Chart(pnlCanvas.getContext('2d'), {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              {
                label: 'Unrealized PnL ($)',
                data: [],
                borderColor: '#4ef7ff',
                backgroundColor: 'rgba(78, 247, 255, 0.15)',
                borderWidth: 2,
                tension: 0.35,
                pointRadius: 0,
                fill: true,
              },
              {
                label: 'Realized PnL Today ($)',
                data: [],
                borderColor: '#ff57f6',
                backgroundColor: 'rgba(255, 87, 246, 0.18)',
                borderWidth: 2,
                tension: 0.35,
                pointRadius: 0,
                fill: true,
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            scales: {
              x: {
                ticks: { color: 'rgba(234, 244, 255, 0.6)', maxTicksLimit: 8 },
                grid: { color: 'rgba(255, 255, 255, 0.06)' }
              },
              y: {
                ticks: {
                  color: 'rgba(234, 244, 255, 0.6)',
                  callback: (val) => `$${Number(val).toLocaleString(undefined, { maximumFractionDigits: 0 })}`
                },
                grid: { color: 'rgba(255, 255, 255, 0.06)' }
              }
            },
            plugins: {
              legend: {
                labels: { color: 'rgba(234, 244, 255, 0.9)', font: { family: 'Rajdhani', size: 12 } }
              },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.dataset.label}: $${Number(ctx.parsed.y).toLocaleString(undefined, { maximumFractionDigits: 2 })}`
                }
              }
            }
          }
        });
      } catch (err) {
        console.error('PnL chart init failed', err);
      }

      try {
        riskChart = new Chart(riskCanvas.getContext('2d'), {
          type: 'bar',
          data: {
            labels: [],
            datasets: [
              {
                label: 'Dollar Risk',
                data: [],
                backgroundColor: 'rgba(255, 83, 112, 0.6)',
                borderRadius: 6,
              },
              {
                label: 'Dollar Reward',
                data: [],
                backgroundColor: 'rgba(78, 247, 255, 0.6)',
                borderRadius: 6,
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: { color: 'rgba(234, 244, 255, 0.6)' },
                grid: { display: false }
              },
              y: {
                ticks: {
                  color: 'rgba(234, 244, 255, 0.6)',
                  callback: (val) => `$${Number(val).toLocaleString(undefined, { maximumFractionDigits: 0 })}`
                },
                grid: { color: 'rgba(255, 255, 255, 0.05)' }
              }
            },
            plugins: {
              legend: {
                labels: { color: 'rgba(234, 244, 255, 0.9)', font: { family: 'Rajdhani', size: 11 } }
              }
            }
          }
        });
      } catch (err) {
        console.error('Risk chart init failed', err);
      }
    })();

    function setConn(state) {
      connPulse.classList.remove('conn-live', 'conn-offline');
      if (state === 'open') {
        connPulse.classList.add('conn-live');
        connText.textContent = 'Live feed';
      } else if (state === 'closed') {
        connPulse.classList.add('conn-offline');
        connText.textContent = 'Disconnected';
      } else {
        connText.textContent = 'Connecting…';
      }
    }

    function renderPortfolio(portfolio) {
      portfolioEl.innerHTML = '';
      if (!portfolio) return;
      const metrics = [
        ['Total Positions', portfolio.total_positions],
        ['Total Notional', formatCurrency(portfolio.total_notional)],
        ['Unrealized PnL', formatCurrency(portfolio.total_unrealized_pnl)],
        ['Risk if SL Hit', formatCurrency(portfolio.total_risk_if_all_sl_hit)],
        ['Reward if TP Hit', formatCurrency(portfolio.total_reward_if_all_tp_hit)],
        ['Risk % of Notional', formatPercent(portfolio.risk_pct_of_notional)],
      ];

      metrics.forEach(([label, value]) => {
        const node = document.createElement('div');
        node.className = 'metric';
        const display = value ?? '-';
        node.innerHTML = `<div class="k">${label}</div><div class="v">${display}</div>`;
        portfolioEl.appendChild(node);
      });

      if (Array.isArray(portfolio.positions_at_risk) && portfolio.positions_at_risk.length) {
        riskAlertsEl.innerHTML = '';
        portfolio.positions_at_risk.forEach((symbol) => {
          const chip = document.createElement('span');
          chip.className = 'chip danger';
          chip.textContent = symbol;
          riskAlertsEl.appendChild(chip);
        });
      } else {
        riskAlertsEl.innerHTML = '';
      }

      if (portfolio.portfolio_risk_reward_ratio !== undefined) {
        const rr = toNumber(portfolio.portfolio_risk_reward_ratio);
        if (Number.isFinite(rr) && rr > 0) {
          portfolioRrEl.textContent = `Risk/Reward — ${rr.toFixed(2)} : 1`;
        } else {
          portfolioRrEl.textContent = 'Risk/Reward — : --';
        }
      }

      summaryPositions.textContent = portfolio.total_positions ?? '-';
      summaryUnrealized.textContent = formatCurrency(portfolio.total_unrealized_pnl ?? '-');
      summaryRisk.textContent = formatCurrency(portfolio.total_risk_if_all_sl_hit ?? '-');
    }

    function renderAccount(account) {
      accountEl.innerHTML = '';
      if (!account || Object.keys(account).length === 0) {
        const empty = document.createElement('div');
        empty.className = 'metric';
        empty.innerHTML = '<div class="k">Status</div><div class="v">Awaiting account telemetry</div>';
        accountEl.appendChild(empty);
        return;
      }
      const metrics = [
        ['Total Equity', formatCurrency(account.total_equity)],
        ['Wallet Balance', formatCurrency(account.total_wallet_balance)],
        ['Available Balance', formatCurrency(account.available_balance)],
        ['Unrealized PnL', formatCurrency(account.total_unrealized_pnl)],
        ["Realized PnL Today", formatCurrency(account.todays_realized_pnl)],
        ["Fees Today", formatCurrency(account.todays_fees)],
        ["Combined PnL", formatCurrency(account.todays_total_pnl)],
      ];
      metrics.forEach(([label, value]) => {
        const node = document.createElement('div');
        node.className = 'metric';
        node.innerHTML = `<div class="k">${label}</div><div class="v">${value}</div>`;
        accountEl.appendChild(node);
      });
    }

    function badgeForHealth(health) {
      const normalized = String(health || 'UNKNOWN').toUpperCase();
      const span = document.createElement('span');
      span.className = 'health-badge';
      span.textContent = normalized.replace('_', ' ');
      if (normalized === 'WARNING') span.classList.add('warning');
      else if (normalized === 'CRITICAL') span.classList.add('critical');
      return span;
    }

    function renderPositions(positions) {
      positionsEl.innerHTML = '';
      if (!positions || Object.keys(positions).length === 0) {
        const empty = document.createElement('div');
        empty.className = 'panel';
        empty.textContent = 'No open positions.';
        positionsEl.appendChild(empty);
        return;
      }

      const entries = Object.entries(positions)
        .filter(([, pos]) => pos && typeof pos === 'object' && pos.symbol)
        .sort(([, a], [, b]) => (severityRank[a.position_health?.toUpperCase?.() || 'UNKNOWN'] ?? 9) - (severityRank[b.position_health?.toUpperCase?.() || 'UNKNOWN'] ?? 9));

      entries.forEach(([symbol, pos]) => {
        const card = document.createElement('article');
        card.className = 'position-card';

        const header = document.createElement('div');
        header.className = 'position-header';

        const symbolBlock = document.createElement('div');
        symbolBlock.className = 'symbol-block';
        const symbolName = document.createElement('div');
        symbolName.className = 'symbol-name';
        symbolName.textContent = symbol;
        const sideTag = document.createElement('span');
        sideTag.className = 'side-tag ' + String(pos.side || pos.position_side || '').toLowerCase();
        sideTag.textContent = (pos.side || pos.position_side || pos.direction || '').toUpperCase();
        symbolBlock.appendChild(symbolName);
        if (sideTag.textContent.trim()) symbolBlock.appendChild(sideTag);

        const healthBadge = badgeForHealth(pos.position_health);

        header.appendChild(symbolBlock);
        header.appendChild(healthBadge);

        const priceMetrics = document.createElement('div');
        priceMetrics.className = 'position-metrics';
        const metrics = [
          ['Entry', fmt(pos.entry_price)],
          ['Mark', fmt(pos.current_price)],
          ['PnL %', formatPercent(pos.current_pnl_pct)],
          ['Notional', formatCurrency(pos.notional)],
          ['Size', fmt(pos.position_size)],
          ['Risk/Reward', pos.risk_reward_ratio ? `${fmt(pos.risk_reward_ratio, 2)} : 1` : '-'],
        ];
        metrics.forEach(([label, value]) => {
          const m = document.createElement('div');
          m.className = 'metric';
          m.innerHTML = `<div class="k">${label}</div><div class="v">${value}</div>`;
          priceMetrics.appendChild(m);
        });

        const levelGroup = document.createElement('div');
        levelGroup.className = 'level-group';
        const sl = document.createElement('div');
        sl.className = 'level';
        sl.innerHTML = `<div class="label">Stop Loss</div><div class="value">${fmt(pos.dynamic_stop_loss ?? pos.stop_loss)}</div>`;
        const tp = document.createElement('div');
        tp.className = 'level';
        tp.innerHTML = `<div class="label">Take Profit</div><div class="value">${fmt(pos.dynamic_take_profit ?? pos.take_profit)}</div>`;
        levelGroup.appendChild(sl);
        levelGroup.appendChild(tp);

        const action = document.createElement('div');
        action.className = 'action-text';
        action.textContent = pos.action_required || 'Monitoring…';

        const confidence = document.createElement('div');
        confidence.className = 'confidence';
        if (Array.isArray(pos.confidence_factors)) {
          pos.confidence_factors.forEach((factor) => {
            const chip = document.createElement('span');
            chip.className = 'factor';
            chip.textContent = factor;
            confidence.appendChild(chip);
          });
        }

        card.appendChild(header);
        card.appendChild(priceMetrics);
        card.appendChild(levelGroup);
        if (confidence.childElementCount) card.appendChild(confidence);
        card.appendChild(action);
        positionsEl.appendChild(card);
      });
    }

    function renderActions(positions) {
      actionFeedEl.innerHTML = '';
      if (!positions) return;
      const entries = Object.entries(positions)
        .filter(([, pos]) => pos && typeof pos === 'object' && pos.action_required)
        .sort(([, a], [, b]) => (severityRank[a.position_health?.toUpperCase?.() || 'UNKNOWN'] ?? 9) - (severityRank[b.position_health?.toUpperCase?.() || 'UNKNOWN'] ?? 9));

      if (!entries.length) {
        const idle = document.createElement('li');
        idle.innerHTML = '<span class="symbol">All systems</span><span>No outstanding actions. Standing by.</span>';
        actionFeedEl.appendChild(idle);
        return;
      }

      entries.forEach(([symbol, pos]) => {
        const item = document.createElement('li');
        item.innerHTML = `<span class="symbol">${symbol}</span><span>${pos.action_required}</span>`;
        actionFeedEl.appendChild(item);
      });
    }

    function updateRiskChart(positions) {
      if (!riskChart || !positions) return;
      const entries = Object.entries(positions)
        .filter(([, pos]) => pos && typeof pos === 'object' && pos.symbol)
        .slice(0, 12);

      const labels = entries.map(([symbol]) => symbol);
      const riskValues = entries.map(([, pos]) => toNumber(pos.current_dollar_risk ?? pos.dollar_risk));
      const rewardValues = entries.map(([, pos]) => toNumber(pos.current_dollar_reward ?? pos.dollar_reward));

      riskChart.data.labels = labels;
      riskChart.data.datasets[0].data = riskValues;
      riskChart.data.datasets[1].data = rewardValues;
      riskChart.update('none');
    }

    function adjustLegend() {
      if (!pnlChart) return;
      const container = pnlCanvas.parentElement;
      if (!container) return;
      const display = (container.clientWidth || 0) > 420;
      if (pnlChart.options.plugins.legend.display !== display) {
        pnlChart.options.plugins.legend.display = display;
        pnlChart.update('none');
      }
    }

    window.addEventListener('resize', adjustLegend);
    adjustLegend();

    function updatePnlChart(account, portfolio) {
      if (!pnlChart) return;
      const now = Date.now();
      if (now - lastSampleAt < SAMPLE_EVERY_MS && pnlSeries.length > 0) return;
      lastSampleAt = now;
      const unreal = Number((account && account.total_unrealized_pnl) ?? (portfolio && portfolio.total_unrealized_pnl) ?? 0);
      const realized = Number((account && account.todays_realized_pnl) ?? 0);
      pnlSeries.push({ t: now, unreal, realized });
      const cutoff = now - THIRTY_FOUR_HOURS_MS;
      while (pnlSeries.length && pnlSeries[0].t < cutoff) pnlSeries.shift();
      const labels = pnlSeries.map((p) => new Date(p.t).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
      pnlChart.data.labels = labels;
      pnlChart.data.datasets[0].data = pnlSeries.map((p) => p.unreal);
      pnlChart.data.datasets[1].data = pnlSeries.map((p) => p.realized);
      const values = pnlSeries.flatMap((p) => [p.unreal, p.realized]).filter((v) => Number.isFinite(v));
      let min = Math.min(...(values.length ? values : [0]));
      let max = Math.max(...(values.length ? values : [0]));
      if (min === max) {
        min -= 1;
        max += 1;
      }
      pnlChart.options.scales.y.min = min;
      pnlChart.options.scales.y.max = max;
      pnlChart.update('none');
    }

    function applySnapshot(snapshot) {
      if (!snapshot) return;
      const portfolio = snapshot.portfolio_metrics ?? snapshot.portfolio;
      const account = snapshot.account_metrics ?? snapshot.account;
      const positions = snapshot.positions;

      renderPortfolio(portfolio);
      renderAccount(account);
      renderPositions(positions);
      renderActions(positions);
      updateRiskChart(positions);
      updatePnlChart(account, portfolio);
      timestampEl.textContent = new Date().toLocaleTimeString();
    }

    async function fetchInitial() {
      try {
        const res = await fetch('/api/analysis');
        if (!res.ok) throw new Error('Failed to fetch initial snapshot');
        const data = await res.json();
        applySnapshot(data);
      } catch (err) {
        console.error('Initial fetch failed', err);
      }
    }

    function connectWS() {
      setConn('connecting');
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const ws = new WebSocket(`${proto}://${location.host}/ws/stream`);
      ws.onopen = () => setConn('open');
      ws.onclose = () => setConn('closed');
      ws.onerror = () => setConn('closed');
      ws.onmessage = (event) => {
        try {
          const payload = JSON.parse(event.data);
          if (payload && !payload.type) applySnapshot(payload);
        } catch (err) {
          console.error('Failed to parse WS payload', err);
        }
      };
    }

    fetchInitial();
    connectWS();
  </script>
</body>
</html>
